<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pick-3 / Pick-4 Portal</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b0f14; color: #e6eef8;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; background: #0f1720; border-bottom: 1px solid #1e293b;
      position: sticky; top: 0; z-index: 10;
    }
    h1 { font-size: 18px; margin: 0; letter-spacing: 0.3px; }
    .btn {
      cursor: pointer; border: 1px solid #334155; background: #111827; color: #e6eef8;
      padding: 8px 12px; border-radius: 10px; font-weight: 600;
    }
    .btn:hover { background: #0b1220; }
    .grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px; padding: 16px;
    }
    .card {
      background: #0f1720; border: 1px solid #1f2a37; border-radius: 16px; padding: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .card h3 { margin: 0 0 8px; font-size: 16px; }
    .pair { font-size: 28px; font-weight: 700; letter-spacing: 2px; }
    .dim { opacity: 0.7; font-size: 12px; }
    .row { display: flex; align-items: center; justify-content: space-between; margin-top: 6px; }
    .admin { position: fixed; right: 12px; bottom: 12px; }
    .kbd { background: #111827; border: 1px solid #1f2937; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>Latest P3-P4 (Single-Origin)</h1>
    <div>
      <button id="syncAllBtn" class="btn">Sync All</button>
      <button id="adminBtn" class="btn admin">Admin</button>
    </div>
  </header>

  <main>
    <div id="grid" class="grid"></div>
  </main>

  <template id="cardTemplate">
    <div class="card">
      <h3><span data-title></span> <span class="dim" data-date></span></h3>
      <div class="row"><span>Midday</span><span class="pair" data-midday>—</span></div>
      <div class="row"><span>Evening</span><span class="pair" data-evening>—</span></div>
      <div class="row dim"><span>Last sync:</span><span data-syncat>—</span></div>
    </div>
  </template>

  <script>
    // ----- Config / API helper -----
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:3000'
      : '';
    const api = (p) => `${API_BASE}${p}`;

    // ----- Local storage adapter (minimal) -----
    const Store = {
      _kFor(d) { return `br_results::${d}`; },
      setById(id, val, dateISO) {
        const k = this._kFor(dateISO);
        const obj = JSON.parse(localStorage.getItem(k) || '{}');
        obj[id] = { v: val, t: Date.now() };
        localStorage.setItem(k, JSON.stringify(obj));
        // legacy mirrors
        localStorage.setItem('br_results_v1', JSON.stringify(obj));
      },
      getById(id, dateISO) {
        const k = this._kFor(dateISO);
        const obj = JSON.parse(localStorage.getItem(k) || '{}');
        return obj[id] || null;
      }
    };

    // ----- UI: seed catalog -----
    // id format: usa/{state}/{draw}
    const CATALOG = [
      { id: 'usa/ny/Midday', title: 'New York' },
      { id: 'usa/nj/Midday', title: 'New Jersey' },
      { id: 'usa/ct/Day',    title: 'Connecticut' },
      { id: 'usa/fl/Midday', title: 'Florida' },
    ];

    // Render cards
    const grid = document.getElementById('grid');
    const T = document.getElementById('cardTemplate');
    const CARDS = {}; // id -> elements

    function renderBoard(dateISO) {
      grid.innerHTML = '';
      CATALOG.forEach((row) => {
        const clone = T.content.cloneNode(true);
        const el = clone.querySelector('.card');
        const els = {
          title: clone.querySelector('[data-title]'),
          date: clone.querySelector('[data-date]'),
          midday: clone.querySelector('[data-midday]'),
          evening: clone.querySelector('[data-evening]'),
          syncat: clone.querySelector('[data-syncat]'),
        };
        els.title.textContent = row.title;
        els.date.textContent = `(${dateISO})`;

        const baseId = row.id.split('/').slice(0, 2).join('/'); // 'usa/ny'
        const idMid = `${baseId}/Midday`;
        const idEve = `${baseId}/Evening`;

        const m = Store.getById(idMid, dateISO);
        const e = Store.getById(idEve, dateISO);
        els.midday.textContent = (m && m.v) || '—';
        els.evening.textContent = (e && e.v) || '—';
        const lastTs = Math.max(m?.t || 0, e?.t || 0);
        els.syncat.textContent = lastTs ? new Date(lastTs).toLocaleTimeString() : '—';

        grid.appendChild(clone);
        CARDS[baseId] = { el, els };
      });
    }

    // Selected date handling
    let SELECTED_DATE = new Date().toISOString().slice(0,10);
    function maybeAdvanceSelectedDate(newISO) {
      if (!newISO) return;
      if (newISO > SELECTED_DATE) {
        SELECTED_DATE = newISO;
        renderBoard(SELECTED_DATE);
      }
    }

    // ----- Sync per-state (with "only bump date if wrote something" patch) -----
    async function fetchJSON(p) {
      const r = await fetch(p, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${r.status}`);
      return r.json();
    }

    async function syncState(stateKey, title) {
      try {
        const data = await fetchJSON(api(`/api/${stateKey}/latest`));
        let wrote = false;
        if (data.midday) { Store.setById(`usa/${stateKey}/Midday`, data.midday, data.dateISO); wrote = true; }
        if (data.evening){ Store.setById(`usa/${stateKey}/Evening`, data.evening, data.dateISO); wrote = true; }
        if (wrote) maybeAdvanceSelectedDate(data.dateISO);
        // update visible card if present
        const baseId = `usa/${stateKey}`;
        const card = CARDS[baseId];
        if (card) {
          card.els.date.textContent = `(${data.dateISO})`;
          card.els.midday.textContent = data.midday || '—';
          card.els.evening.textContent = data.evening || '—';
          card.els.syncat.textContent = new Date().toLocaleTimeString();
        }
      } catch (e) {
        console.warn('syncState failed', stateKey, e.message);
      }
    }

    async function syncAll() {
      await Promise.all([
        syncState('ny', 'New York'),
        syncState('nj', 'New Jersey'),
        syncState('ct', 'Connecticut'),
        syncState('fl', 'Florida'),
      ]);
    }

    // ----- Admin (simple PIN for dev only) -----
    document.getElementById('adminBtn').addEventListener('click', () => {
      const pin = prompt('Enter Admin PIN');
      if (pin === '1983') {
        const act = prompt('Admin action:\n1) Clear local cache\n2) Show debug URLs');
        if (act === '1') {
          localStorage.clear();
          alert('Local cache cleared. Reloading.');
          location.reload();
        } else if (act === '2') {
          alert([
            'Debug endpoints:',
            `${api('/api/_debug/ny')}`,
            `${api('/api/_debug/nj')}`,
            `${api('/api/_debug/ct')}`,
            `${api('/api/_debug/fl')}`
          ].join('\n'));
        }
      } else if (pin !== null) {
        alert('Invalid PIN.');
      }
    });

    // Buttons
    document.getElementById('syncAllBtn').addEventListener('click', syncAll);

    // Initial render and first sync
    renderBoard(SELECTED_DATE);
    syncAll();

    // Auto refresh: lighter cadence; you can tune by local time windows.
    setInterval(syncAll, 60_000);
  </script>
</body>
</html>
